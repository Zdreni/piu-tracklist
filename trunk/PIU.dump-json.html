<!DOCTYPE html>
<html>
	<script src="include/underscore/underscore-min.js"></script>
</head>

<script src="tracklist.js"></script>
<script src="tracklist_src.js"></script>
<!--
<script src="check.js"></script>
<script src="check_Exceed2_Zero.js"></script>
<script src="check_NX.js"></script>
<script src="check_NX2_NXA.js"></script>
-->
<!-- -->
<script src="tracklist_bpms.js"></script>
<script src="tracklist_unlocks.js"></script>
<script src="tracklist_level_estimations.js"></script>
<script src="tracklist_tags.js"></script>
<!-- <script src="verify_bpms.js"></script> -->

<code>
<script>
function JStr( obj )
{
	return JSON.stringify( obj, null, 1 );
}

function JStrNoQuotes( obj )
{
	var jstr = JStr( obj );
	return jstr.substring( 3, jstr.length - 2 );
}

function DictToArr( dict, func )
{
	return Object.keys( dict ).map( function ( key ) {  return func( key, dict[ key ] );  } );
}

// document.write( JSON.stringify( tracklist, null, 2 ) );
for( var trackID in tracklist )
{
	var track = tracklist[ trackID ];

	for( var mixID of mixesOrder )
	{
		delete track.chartsCount;

		var mixCharts = track[ mixID ];
		if( ! mixCharts )
			continue;

		track[ mixID ] = {};
		for( var chart of mixCharts )
		{
			//if( chart.innerLevelNum === chart.levelNum )
			//	delete chart.innerLevelNum;

			if( String( chart.levelNum ) === chart.levelText )
				delete chart.levelNum;

			var newTagIndex = NewTags.indexOf( chart.tag );
			if( newTagIndex >= 0 )
			{
				if( NewTagTypes[ newTagIndex ] === chart.type )
					delete chart.type;
			}

			var oldArcadeTagIndex = OldArcadeTags.indexOf( chart.tag );
			if( oldArcadeTagIndex >= 0 )
			{
				if( track.duration === STANDARD  &&  chart.zone === ARCADE )
					delete chart.zone;
				if( ( track.duration === REMIX  ||  track.duration === FULL )  &&  chart.zone === SPECIAL )
					delete chart.zone;
				if( OldTagTypes[ oldArcadeTagIndex ] === chart.type )
					delete chart.type;
			}

			var oldSpecialTagIndex = OldSpecialTags.indexOf( chart.tag );
			if( oldSpecialTagIndex >= 0 )
			{
				if( chart.zone === SPECIAL )
					delete chart.zone;
				if( OldTagTypes[ oldSpecialTagIndex ] === chart.type )
					delete chart.type;
			}

			chart.text = chart.tag + "-" + chart.levelText;
			delete chart.tag;
			delete chart.levelText;
			if( isNaN( chart.levelNum )  ||  chart.levelNum === null )
				delete chart.levelNum;

			//if( chart.levelText === chart.text )
			//	delete chart.levelText;

			var chartIndex = chart.shared.index;
			delete chart.shared;
			delete chart.fromMixID;
			if( Object.keys( chart ).length === 1 )  // only "text"
				chart = chart.text;
			track[ mixID ][ chartIndex ] = chart;
		}
	}

	if( track.duration == "Standard" )
		delete track.duration;

	track.title = track.title.replace( "  ", "&nbsp;&nbsp;" );
}

//document.write( Object.keys( tracklist ).length + " tracks:<br><br>")

document.write("{<br><br>");

result = ""

var nextTrack = false;
for( var trackID in tracklist )
{
	if( nextTrack )
		result += ",<br><br>";
	else
		nextTrack = true;

	var track = tracklist[ trackID ];

	var mixesTemp = {};
	for( var mixID of mixesOrder )
	{
		mixesTemp[ mixID ] = track[ mixID ];
		delete track[ mixID ];
	}

	var charts = track.charts;
	delete track.charts;
	for( var chartIndex in charts )
	{
		var shared = charts[ chartIndex ];
		delete shared.index;
		delete shared.type;
		if( Object.keys(shared).length === 0 )
			delete charts[ chartIndex ];
	}

	result += JStr( trackID ) + ": {<br>&nbsp;" + JStrNoQuotes( track ) + ",<br>";

	if( Object.keys( charts ).length > 0 )
	{
		var chartsArr = DictToArr( charts, function ( key, val ) {  return "&nbsp;&nbsp;" + JStr( key ) + ": " + JStr( val );  } );
		result += "\t&nbsp;\"charts\": {<br>" + chartsArr.join( ",<br>" ) + "<br>&nbsp;},<br>";
	}

	var nextMix = false;
	for( var mixID of mixesOrder )
	{
		var mixCharts = mixesTemp[ mixID ];
		if( mixCharts )
		{
			if( nextMix )
				result += ",<br>";
			else
				nextMix = true;
			result += "\t&nbsp;" + JStr( mixID ) + ": {<br>";

			var mixChartsArr = DictToArr( mixCharts, function ( key, val ) {  return "&nbsp;&nbsp;" + JStr( key ) + ": " + JStr( val );  } );
			result += mixChartsArr.join( ",<br>" );

			result += "<br>&nbsp;}";
		}
	}
	result += "<br>}";
}
document.write( result );
document.write("<br><br>}");
</script>
</code>

</body>
</html>
